use meme_generator_core::error::Error;
use meme_generator_utils::{
    builder::InputImage,
    encoder::GifEncoder,
    image::ImageExt,
    tools::{load_image, local_date},
};

use crate::{options::NoOptions, register_meme, tags::MemeTags};

fn stickman_dancing(
    images: Vec<InputImage>,
    _: Vec<String>,
    _: NoOptions,
) -> Result<Vec<u8>, Error> {
    let locs = [
        (194, 53),
        (194, 53),
        (194, 52),
        (195, 52),
        (196, 52),
        (197, 52),
        (198, 51),
        (199, 51),
        (200, 51),
        (201, 51),
        (201, 52),
        (202, 53),
        (200, 53),
        (198, 54),
        (196, 54),
        (194, 54),
        (192, 55),
        (190, 55),
        (190, 54),
        (192, 53),
        (194, 53),
        (194, 52),
        (195, 52),
        (196, 52),
        (195, 52),
        (194, 52),
        (194, 53),
        (193, 53),
        (192, 53),
        (191, 53),
        (191, 54),
        (190, 54),
        (189, 54),
        (190, 54),
        (191, 54),
        (192, 53),
        (192, 53),
        (193, 53),
        (194, 53),
        (194, 52),
        (195, 52),
        (196, 52),
        (195, 52),
        (194, 52),
        (193, 53),
        (193, 53),
        (192, 53),
        (191, 54),
        (190, 54),
        (190, 54),
        (190, 54),
        (191, 54),
        (191, 53),
        (192, 53),
        (193, 53),
        (194, 53),
        (194, 52),
        (195, 52),
        (196, 52),
        (196, 52),
        (197, 52),
        (198, 51),
        (199, 51),
        (200, 51),
        (201, 51),
        (200, 52),
        (201, 52),
        (202, 53),
        (199, 53),
        (197, 54),
        (195, 54),
        (193, 54),
        (191, 55),
        (190, 54),
        (192, 53),
        (194, 53),
        (194, 52),
        (195, 52),
        (196, 52),
        (197, 52),
        (198, 51),
        (199, 51),
        (200, 51),
        (201, 51),
        (201, 52),
        (202, 53),
        (200, 53),
        (197, 54),
        (195, 54),
        (193, 54),
        (191, 55),
        (190, 54),
        (192, 53),
        (194, 53),
        (195, 52),
        (196, 52),
        (197, 52),
        (198, 51),
        (199, 51),
        (200, 51),
        (201, 52),
        (202, 53),
        (200, 53),
        (197, 54),
        (195, 54),
        (193, 54),
        (191, 55),
        (190, 54),
        (189, 58),
    ];
    let img = images[0].image.circle().resize_exact((138, 138));

    let mut encoder = GifEncoder::new();
    for i in 0..109 {
        let frame = load_image(format!("stickman_dancing/{i:03}.png"))?;
        let mut surface = frame.to_surface();
        let canvas = surface.canvas();
        canvas.draw_image(&img, locs[i], None);
        encoder.add_frame(surface.image_snapshot(), 0.03)?;
    }
    Ok(encoder.finish()?)
}

register_meme!(
    "stickman_dancing",
    stickman_dancing,
    min_images = 1,
    max_images = 1,
    keywords = &["跳舞", "火柴人跳舞"],
    tags = MemeTags::stickman(),
    date_created = local_date(2025, 4, 30),
    date_modified = local_date(2025, 4, 30),
);
