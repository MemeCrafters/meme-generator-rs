use skia_safe::{Color, Image};

use meme_generator_core::error::Error;
use meme_generator_utils::{
    builder::DecodedImage,
    encoder::{make_gif_or_combined_gif, GifInfo},
    image::ImageExt,
    tools::{load_image, local_date, new_surface},
};

use crate::{options::NoOptions, register_meme};

fn chase_train(
    images: &mut Vec<DecodedImage>,
    _: &Vec<String>,
    _: &NoOptions,
) -> Result<Vec<u8>, Error> {
    let locs = [
        (35, 34, 128, 44),
        (35, 33, 132, 40),
        (33, 34, 133, 36),
        (33, 38, 135, 41),
        (34, 34, 136, 38),
        (35, 35, 136, 33),
        (33, 34, 138, 38),
        (36, 35, 138, 34),
        (38, 34, 139, 32),
        (40, 35, 139, 37),
        (36, 35, 139, 33),
        (39, 36, 138, 28),
        (40, 35, 138, 33),
        (37, 34, 138, 31),
        (43, 36, 135, 27),
        (36, 37, 136, 32),
        (38, 40, 135, 26),
        (37, 35, 133, 26),
        (33, 36, 132, 30),
        (33, 39, 132, 25),
        (32, 36, 131, 23),
        (33, 36, 130, 31),
        (35, 39, 128, 25),
        (33, 35, 127, 23),
        (34, 36, 126, 29),
        (34, 40, 124, 25),
        (39, 36, 119, 23),
        (35, 36, 119, 32),
        (35, 37, 116, 27),
        (36, 38, 113, 23),
        (34, 35, 113, 32),
        (39, 36, 113, 23),
        (36, 35, 114, 17),
        (36, 38, 111, 13),
        (34, 37, 114, 15),
        (34, 39, 111, 10),
        (33, 39, 109, 11),
        (36, 35, 104, 17),
        (34, 36, 102, 14),
        (34, 35, 99, 14),
        (35, 38, 96, 16),
        (35, 35, 93, 14),
        (36, 35, 89, 15),
        (36, 36, 86, 18),
        (36, 39, 83, 14),
        (34, 36, 81, 16),
        (40, 41, 74, 17),
        (38, 36, 74, 15),
        (39, 35, 70, 16),
        (33, 35, 69, 20),
        (36, 35, 66, 17),
        (36, 35, 62, 17),
        (37, 36, 57, 21),
        (35, 39, 57, 15),
        (35, 36, 53, 17),
        (35, 38, 51, 20),
        (37, 36, 47, 19),
        (37, 35, 47, 18),
        (40, 36, 43, 19),
        (38, 35, 42, 22),
        (40, 34, 38, 20),
        (38, 34, 37, 21),
        (39, 32, 35, 24),
        (39, 33, 33, 22),
        (39, 36, 32, 22),
        (38, 35, 32, 25),
        (35, 37, 31, 22),
        (37, 37, 31, 23),
        (36, 31, 31, 28),
        (37, 34, 32, 25),
        (36, 37, 32, 23),
        (36, 33, 33, 30),
        (35, 34, 33, 27),
        (38, 33, 33, 28),
        (37, 34, 33, 29),
        (36, 35, 35, 28),
        (36, 37, 36, 27),
        (43, 39, 33, 30),
        (35, 34, 38, 31),
        (37, 34, 39, 30),
        (36, 34, 40, 30),
        (39, 35, 41, 30),
        (41, 36, 41, 29),
        (40, 37, 44, 32),
        (40, 37, 45, 29),
        (39, 38, 48, 28),
        (38, 33, 50, 33),
        (35, 38, 53, 28),
        (37, 34, 54, 31),
        (38, 34, 57, 32),
        (41, 35, 57, 29),
        (35, 34, 63, 29),
        (41, 35, 62, 29),
        (38, 35, 66, 28),
        (35, 33, 70, 29),
        (40, 39, 70, 28),
        (36, 36, 74, 28),
        (37, 35, 77, 26),
        (37, 35, 79, 28),
        (38, 35, 81, 27),
        (36, 35, 85, 27),
        (37, 36, 88, 29),
        (36, 34, 91, 27),
        (38, 39, 94, 24),
        (39, 34, 95, 27),
        (37, 34, 98, 26),
        (36, 35, 103, 24),
        (37, 36, 99, 28),
        (34, 36, 97, 34),
        (34, 38, 102, 38),
        (37, 37, 99, 40),
        (39, 36, 101, 47),
        (36, 36, 106, 43),
        (35, 35, 109, 40),
        (35, 39, 112, 43),
        (33, 36, 116, 41),
        (36, 36, 116, 39),
        (34, 37, 121, 45),
        (35, 41, 123, 38),
        (34, 37, 126, 35),
    ];

    let func = |i: usize, images: &Vec<Image>| {
        let frame = load_image(&format!("chase_train/{i:03}.png"))?;
        let mut surface = new_surface(frame.dimensions());
        let canvas = surface.canvas();
        canvas.clear(Color::WHITE);
        let (w, h, x, y) = locs[i];
        let image = images[0].square().resize_exact((w, h));
        canvas.draw_image(&image, (x, y), None);
        canvas.draw_image(&frame, (0, 0), None);
        Ok(surface.image_snapshot())
    };

    make_gif_or_combined_gif(
        images,
        func,
        GifInfo {
            frame_num: 120,
            duration: 0.05,
        },
        None,
    )
}

register_meme!(
    "chase_train",
    chase_train,
    min_images = 1,
    max_images = 1,
    keywords = &["追列车", "追火车"],
    date_created = local_date(2023, 1, 8),
    date_modified = local_date(2023, 2, 14),
);
